<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="style.css" rel="stylesheet"/>
        <script src="js/main.js"></script>
        <script src="js/pokeReport.js"></script>
        <script src="js/pokedex2.js"></script>

        <title>レポート(仮)v0.0.5tt</title>
        <style>
            .example2{
                display: flex;
            }
            .example2 label{
                background: #DDDDDD;
                color: #666666;
                padding: 1px;
                margin: 3px;
                text-align: center;
                border-radius: 5px;
                cursor: pointer;
            }
            .example2 input:checked+label{
                background: #60ffca;
                color: #000000;
            }
            .example2 input{
                display: none;
            }
            </style>
    </head>


    <body>
        <p id="page_link">
            <a href = "./index.html"><img src="img/pages/pokedex.png"></a>
            <a href = "./sleep.html"><img src="img/pages/sleep.png"></a>
            <a href = "./cook.html"><img src="img/pages/cook.png"></a>
            <a href = "./report.html" class="current"><img src="img/pages/report.png"></a>
        </p>

            <div id="food_buttons">
                <img name="とくせんリンゴ" src="img/food/とくせんリンゴ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="モーモーミルク" src="img/food/モーモーミルク.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ワカクサ大豆" src="img/food/ワカクサ大豆.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あまいミツ" src="img/food/あまいミツ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="マメミート" src="img/food/マメミート.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あったかジンジャー" src="img/food/あったかジンジャー.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あんみんトマト" src="img/food/あんみんトマト.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="とくせんエッグ" src="img/food/とくせんエッグ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ピュアなオイル" src="img/food/ピュアなオイル.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ほっこりポテト" src="img/food/ほっこりポテト.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="げきからハーブ" src="img/food/げきからハーブ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="リラックスカカオ" src="img/food/リラックスカカオ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あじわいキノコ" src="img/food/あじわいキノコ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ふといながねぎ" src="img/food/ふといながねぎ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="おいしいシッポ" src="img/food/おいしいシッポ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ワカクサコーン" src="img/food/ワカクサコーン.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="めざましコーヒー" src="img/food/めざましコーヒー.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
            </div>
            <input type="text" id="food_min" style="width:3em;" value="0">個以上
            <input type="checkbox" id="only_fully_evolved" checked="true">最終進化のみ(イワーク、ヤルキモノを除く)
            <div>
                Myポケモン登録フォームv2:<br>
                <select id="input_mypoke_name" style="width:10em; font-size:1em" onclick="initializePokeList()" onchange="setFoodImages(this)"></select>
                Lv<select id="input_mypoke_lv" style="width:4em; font-size:1em" onclick="initializePokeList()"></select>

                <img id="input_mypoke_food_1" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <img id="input_mypoke_food_2" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <img id="input_mypoke_food_3" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <br>
                <select id="input_mypoke_char" style="width:15.5em; font-size:1em">
                    <option value = '{"speedAdj": 0.11, "foodAdj": 0.0}' characteristic="寂">さみしがり (速↑元↓)</option>
                    <option value = '{"speedAdj": 0.11, "foodAdj":-0.2}' characteristic="い">いじっぱり (速↑食↓)</option>
                    <option value = '{"speedAdj": 0.11, "foodAdj": 0.0}' characteristic="や">やんちゃ (速↑ス↓)</option>
                    <option value = '{"speedAdj": 0.11, "foodAdj": 0.0}' characteristic="勇">ゆうかん (速↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj": 0.0}' characteristic="ず">ずぶとい (元↑速↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj":-0.2}' characteristic="わ">わんぱく (元↑食↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="能">のうてんき (元↑ス↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="の">のんき (元↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj": 0.2}' characteristic="ひ">ひかえめ (食↑速↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.2}' characteristic="お">おっとり (食↑元↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.2}' characteristic="う">うっかりや (食↑ス↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.2}' characteristic="冷">れいせい (食↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj": 0.0}' characteristic="穏">おだやか (ス↑速↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="大">おとなしい (ス↑元↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj":-0.2}' characteristic="慎">しんちょう (ス↑食↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="な">なまいき (ス↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj": 0.0}' characteristic="臆">おくびょう (E↑速↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="せ">せっかち (E↑元↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj":-0.2}' characteristic="陽">ようき (E↑食↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="む">むじゃき (E↑ス↓)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="□">がんばりや (無補正)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="□">すなお (無補正)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="□">てれや (無補正)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="□">きまぐれ (無補正)</option>
                    <option value = '{"speedAdj": 0.00, "foodAdj": 0.0}' characteristic="□">まじめ (無補正)</option>
                </select>

                <div class="example2">
                    <input type="checkbox" id="input_mypoke_speedS"><label for="input_mypoke_speedS">おてスピS</label>
                    <input type="checkbox" id="input_mypoke_speedM"><label for="input_mypoke_speedM">おてスピM</label>
                    <input type="checkbox" id="input_mypoke_foodS"><label for="input_mypoke_foodS">食材S</label>
                    <input type="checkbox" id="input_mypoke_foodM"><label for="input_mypoke_foodM">食材M</label>
                </div>

                <button id="input_mypoke_register" style="font-size:0.7em; vertical-align: middle;" onclick="registerMyPoke();">Myポケモンをマイセットに追加</button> 
                <button id="input_mypoke_reset" style="font-size:0.7em; vertical-align: middle;" onclick="resetInputForm();">リセット</button>
                
                <br>
                <select id="input_mypoke_registered" style="width:15em; font-size:1em; vertical-align: middle;">
                </select>
                <button id="input_mypoke_delete" style="font-size:0.7em; vertical-align: middle;" onclick="deleteRegisteredMypoke()">削除</button>




            </div>

            <div>

            </div>

            <div id="result">
                <table id="result_table">

                </table>
            </div>
        </p>




        <!--以下、スクリプト-->
        <script>
            function addReportOf(el){
                let foodName = el.name;
                let min = document.getElementById('food_min').value;
                let onlyFullyEvolved = document.getElementById('only_fully_evolved').checked;
                let t = document.getElementById('result_table');
                t.innerHTML = "";
                t.appendChild(this.pokeReport.createReport(foodName, min, onlyFullyEvolved));
                
                this.insertRegisteredMyPokemons(foodName);

                let json = this.createMyPokeJsonFromInputForm();
                if (json == null) return;

                this.insertMyPokemon(json, foodName, "#FFFF99");
            }


            //Myポケモン関連
            function insertRegisteredMyPokemons(food){
                let options = document.getElementById("input_mypoke_registered").children;
                
                for (let i = 0; i < options.length; i++){
                    let x = this.cookieItemToJson(options[i].value);
                    this.insertMyPokemon(x, food);
                }
            }


            function insertMyPokemon(json, food, colorCode = "#CCDDFF"){
                let poke = pokedex.getPokemonByName(json.name);
                let comb = new FoodCombination(poke, json.lv, poke.getOtetsudaiCountDay(json.lv, json.speedAdj, json.subSpeedAdj), json.code, json.foodAdj + json.subFoodAdj);
                if (!comb.contains(food))   return;

                let tr = document.createElement('tr');
                tr.style.backgroundColor = colorCode;
                comb.insertResultTo(tr, food, poke);

                let tb = document.getElementById('result_table').tBodies[0];
                let rows = tb.children;

                let target = comb.getExpectionOf(food);
                for (let i = 0; i < rows.length; i++){
                    let value = rows[i].children[1].getAttribute('value');
                    if (value <= target){
                    tb.insertBefore(tr, rows[i]);
                        break;
                    }
                }
            }

            function createMyPokeJsonFromInputForm(){
                let name = this.document.getElementById('input_mypoke_name').value;
                if (name == "") return null;

                return this.createAdjustJson(name);
            }


            function createAdjustJson(name){
                let charList = document.getElementById("input_mypoke_char");
                let json = JSON.parse(charList.children[charList.selectedIndex].value);
                json.subSpeedAdj = (document.getElementById("input_mypoke_speedS").checked) ? 0.07 : 0;
                json.subSpeedAdj += (document.getElementById("input_mypoke_speedM").checked) ? 0.14 : 0;
                json.subFoodAdj = (document.getElementById("input_mypoke_foodS").checked) ? 0.18 : 0;
                json.subFoodAdj += (document.getElementById("input_mypoke_foodM").checked) ? 0.36 : 0; 
                json.subSpeedAdj = Math.round(json.subSpeedAdj * 100) / 100;
                json.subFoodAdj = Math.round(json.subFoodAdj * 100) / 100;

                json.characteristic = charList.children[charList.selectedIndex].getAttribute("characteristic");
                json.identifier = "";
                if (document.getElementById("input_mypoke_speedS").checked) json.identifier += ".";
                if (document.getElementById("input_mypoke_speedM").checked) json.identifier += ":" ;
                if (document.getElementById("input_mypoke_foodS").checked)  json.identifier += "f";
                if (document.getElementById("input_mypoke_foodM").checked)  json.identifier += "F"; 

                json.name = name;
                json.lv = this.document.getElementById('input_mypoke_lv').value;
                json.code = this.getMyPokeFoodCode();
                return json;
            }


            function getMyPokeFoodCode(){
                return document.getElementById("input_mypoke_food_1").getAttribute("code")
                     + document.getElementById("input_mypoke_food_2").getAttribute("code")
                     + document.getElementById("input_mypoke_food_3").getAttribute("code");
            }




            //クッキー関連(登録)
            function setMyPokeCookie(){
                let options= document.getElementById("input_mypoke_registered").children;
                let values = [];
                for (let i = 0; i < options.length; i++){
                    values.push(options[i].value);
                }
            
                setCookie("myPokeList", values.join("/"), 30);
                alert(getCookie("myPokeList"));
            }     





            //クッキー関連(呼び出し)
            function setMypokesToListFromCookie(){
                let c = getCookie("myPokeList")
                if (c == null) return; 

                let jss = cookieItemToJsons(c);
                if (jss == null) return;
                for (let i = 0; i < jss.length; i++){
                    let maxFlag = this.addMyPokeToList(this.createMyPokeOption(jss[i]));
                    if (maxFlag){
                        alert("限界");
                        return;
                    }            
                }
            }   


            function fff(){//テスト用
                let jss = cookieItemToJsons('738,30,AAA,yn,.:,0.11,0,0.21,0/9,60,ABA,yu,F,0.11,0,0,0.36/910,30,AAA,sb,F,0.11,0,0,0.36');
                for (let i = 0; i < jss.length; i++){
                    let maxFlag = this.addMyPokeToList(this.createMyPokeOption(jss[i]));
                    if (maxFlag){
                        alert("限界");
                        return;
                    }            
                }
            }

            function cookieItemToJsons(c){
                let ccc = c.split("/");
                let jss = [];

                for (let i = 0; i < ccc.length; i++){
                    jss.push(this.cookieItemToJson(ccc[i]));
                }
                return jss;
            }

            function cookieItemToJson(str){
                let tmp = str.split(",");
                
                return{
                    name: this.pokedex.getPokemonByNo(Number(tmp[0])).name,
                    lv: Number(tmp[1]),
                    code: tmp[2],
                    characteristic: this.characteristicConv(tmp[3]),
                    identifier: tmp[4],
                    speedAdj: Number(tmp[5]),
                    foodAdj: Number(tmp[6]),
                    subSpeedAdj: Number(tmp[7]),
                    subFoodAdj: Number(tmp[8])
                };
            }









            //ロード時、ボタンなどから直接呼び出される可能性があるもの
            function setFoodImages(el){
                let poke = pokedex.getPokemonByName(el.value);
                if (poke == null){
                    return;
                }
                
                let img1 = document.getElementById('input_mypoke_food_1');
                let img2 = document.getElementById('input_mypoke_food_2');
                let img3 = document.getElementById('input_mypoke_food_3');
                this.setFoodImageOnImgEl(img1, poke, 1);
                this.setFoodImageOnImgEl(img2, poke, 2);
                this.setFoodImageOnImgEl(img3, poke, 3);
            }


            function setFoodImageOnImgEl(el, poke, max){
                let values = poke.getAllFoodNames();
                let value = values[0];
                el.setAttribute("values", values.slice(0, max).join(","));
                el.setAttribute("value", value);
                el.setAttribute("code", "A")
                this.toggleFood(el, 0);
            }


            function toggleFood(el, setIndex = -1){
                let values = el.getAttribute("values").split(",");
                let index = values.indexOf(el.getAttribute("value"));
                let next = (setIndex != -1) ? setIndex
                          : ((index + 1) >= values.length) ? 0 : index + 1;
                
                el.src = el.getAttribute("dir") + values[next] + ".png";
                el.setAttribute("value", values[next]);
                el.setAttribute("code", String.fromCharCode(65 + next));               
            }


            function resetInputForm(){
                let res = window.confirm("入力情報をリセットしてもよろしいですか？");
                if (res == false) return;

                document.getElementById('input_mypoke_name').selectedIndex = 0;
                document.getElementById('input_mypoke_lv').selectedIndex = 29;
                document.getElementById("input_mypoke_char").selectedIndex = 0;
                document.getElementById("input_mypoke_speedS").checked = false;
                document.getElementById("input_mypoke_speedM").checked = false;
                document.getElementById("input_mypoke_foodS").checked = false;
                document.getElementById("input_mypoke_foodM").checked = false;
            }



            function registerMyPoke(){
                let json = this.createMyPokeJsonFromInputForm();
                if (json == null){
                    alert("登録情報が足りていません。")
                    return;
                }

                let res = window.confirm(json.name +  "\nを登録してもよろしいですか？");
                if (res == false) return;

                this.addMyPokeToList(this.createMyPokeOption(json));
                this.setMyPokeCookie();
            }


            function addMyPokeToList(op){
                let myList = document.getElementById("input_mypoke_registered");
                if (myList.children.length >= 30){
                    alert("マイポケモンは30体まで登録可能です。");
                    return;
                }
                myList.appendChild(op);
                return myList.children.length >= 30;
            }


            function deleteRegisteredMypoke(){
                let list = document.getElementById("input_mypoke_registered");
                if (list.children.length == 0) return;

                let op = list.children[list.selectedIndex];                
                let res = window.confirm(op.textContent +  "\nを削除してもよろしいですか？");
                if (res == false) return;

                list.removeChild(op);
                this.setMyPokeCookie();
            }


            function createMyPokeOption(json){
                let op = document.createElement("option");
                op.value = this.jsonToOptionValue(json);
                op.text = json.name + "Lv" + json.lv + json.code + " " + json.characteristic + json.identifier;
                return op;
            }


            function jsonToOptionValue(json){
                return [
                   this.pokedex.getNoByName(json.name),
                   json.lv,
                   json.code,
                   this.characteristicConv(json.characteristic),
                   json.identifier,
                   json.speedAdj,
                   json.foodAdj,
                   json.subSpeedAdj,
                   json.subFoodAdj
                ];
            }

            function characteristicConv(v){
                switch(v){
                    case "寂": return "sb"; break;
                    case "い": return "ij"; break;
                    case "や": return "yn"; break;
                    case "勇": return "yu"; break;
                    case "ず": return "zb"; break;
                    case "わ": return "wp"; break;
                    case "能": return "nt"; break;
                    case "の": return "nn"; break;
                    case "ひ": return "hk"; break;
                    case "お": return "or"; break;
                    case "う": return "uk"; break;
                    case "冷": return "ri"; break;
                    case "穏": return "od"; break;
                    case "大": return "on"; break;
                    case "慎": return "sn"; break;
                    case "な": return "nm"; break;
                    case "臆": return "ok"; break;
                    case "せ": return "sk"; break;
                    case "陽": return "yu"; break;
                    case "む": return "mj"; break;
                    case "□": return "xx"; break;

                    case "sb": return "寂"; break;
                    case "ij": return "い"; break;
                    case "yn": return "や"; break;
                    case "yu": return "勇"; break;
                    case "zb": return "ず"; break;
                    case "wp": return "わ"; break;
                    case "nt": return "能"; break;
                    case "nn": return "の"; break;
                    case "hk": return "ひ"; break;
                    case "or": return "お"; break;
                    case "uk": return "う"; break;
                    case "ri": return "冷"; break;
                    case "od": return "穏"; break;
                    case "on": return "大"; break;
                    case "sn": return "慎"; break;
                    case "nm": return "な"; break;
                    case "ok": return "臆"; break;
                    case "sk": return "せ"; break;
                    case "yu": return "陽"; break;
                    case "mj": return "む"; break;
                    case "xx": return "□"; break;
                    default: return "--";
                }                
            }

       



            function initializePokeList(){
                if (this.selectBoxInitialized) return;

                let list = document.getElementById('input_mypoke_name');
                let blankOp = document.createElement('option');
                blankOp.text = "";
                blankOp.value = "";
                list.appendChild(blankOp);

                let names = pokemons.map(p => p.name).sort();
                for (let i = 0; i < names.length; i++){
                    let op = document.createElement('option');                    
                    op.text = names[i];
                    op.value = names[i];   
                    list.appendChild(op);                 
                }

                list = document.getElementById('input_mypoke_lv');
                blankOp = document.createElement('option');


                for (let i = 1; i <= 60; i++){
                    let op = document.createElement('option');                    
                    op.text = i;
                    op.value = i;   
                    list.appendChild(op);                 
                }
                list.selectedIndex = 29;

                this.selectBoxInitialized = true;
            }

            //ロード時のイベント
            window.onload = ()=>{
                this.pokedex = new Pokedex();
                this.pokemons = pokedex.pokemons;
                this.pokeReport = new PokeReport(this.pokedex);
                this.pokeReport.initialize();
                this.selectBoxInitialized = false;
                setMypokesToListFromCookie();
            }
        </script>
    </body>

</html>
