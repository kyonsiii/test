<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="style.css" rel="stylesheet"/>
        <script src="js/main.js"></script>
        <script src="js/pokeReport.js"></script>
        <script src="js/pokedex2.js"></script>

        <title>レポート(仮)v0.0.1</title>
        <style>
            .example2{
                display: flex;
            }
            .example2 label{
                background: #DDDDDD;
                color: #666666;
                padding: 1px;
                margin: 3px;
                text-align: center;
                border-radius: 5px;
                cursor: pointer;
            }
            .example2 input:checked+label{
                background: #60ffca;
                color: #000000;
            }
            .example2 input{
                display: none;
            }
            </style>
    </head>


    <body>
        <p>
            <a href = "./index.html">ポケモン</a>
            <a href = "./sleep.html">睡眠計算</a>
            <a href = "./cook.html">料理</a>
            <a href = "./report.html" class="current">レポート(仮)</a>
        </p>

            <div id="food_buttons">
                <img name="とくせんリンゴ" src="img/food/とくせんリンゴ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="モーモーミルク" src="img/food/モーモーミルク.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ワカクサ大豆" src="img/food/ワカクサ大豆.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あまいミツ" src="img/food/あまいミツ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="マメミート" src="img/food/マメミート.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あったかジンジャー" src="img/food/あったかジンジャー.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あんみんトマト" src="img/food/あんみんトマト.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="とくせんエッグ" src="img/food/とくせんエッグ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ピュアなオイル" src="img/food/ピュアなオイル.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ほっこりポテト" src="img/food/ほっこりポテト.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="げきからハーブ" src="img/food/げきからハーブ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="リラックスカカオ" src="img/food/リラックスカカオ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="あじわいキノコ" src="img/food/あじわいキノコ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ふといながねぎ" src="img/food/ふといながねぎ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="おいしいシッポ" src="img/food/おいしいシッポ.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="ワカクサコーン" src="img/food/ワカクサコーン.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
                <img name="めざましコーヒー" src="img/food/めざましコーヒー.png" onclick="addReportOf(this);pokeReport.selectIcon(this);">
            </div>
            <input type="text" id="food_min" style="width:3em;" value="0">個以上
            <input type="checkbox" id="only_fully_evolved" checked="true">最終進化のみ(イワーク、ヤルキモノを除く)
            <div>
                マイポケモン登録フォームv2:<br>
                <select id="input_mypoke_name" style="width:10em; font-size:1em" onclick="initializePokeList()" onchange="setFoodImages(this)"></select>
                Lv<select id="input_mypoke_lv" style="width:3em; font-size:1em" onclick="initializePokeList()"></select>

                <img id="input_mypoke_food_1" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <img id="input_mypoke_food_2" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <img id="input_mypoke_food_3" src="" dir="img/food/" class="ex-tiny" style="vertical-align: bottom;" onclick="toggleFood(this)">
                <br>
                <select id="input_mypoke_char" style="width:15em; font-size:1em">
                    <option value = '{"speedAdj":0.11,  "foodAdj":0.00}'>さみしがり (速↑元↓)</option>
                    <option value = '{"speedAdj":0.11,  "foodAdj":-0.2}'>いじっぱり (速↑食↓)</option>
                    <option value = '{"speedAdj":0.11,  "foodAdj":0.00}'>やんちゃ (速↑ス↓)</option>
                    <option value = '{"speedAdj":0.11,  "foodAdj":0.00}'>ゆうかん (速↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj":0.00}'>ずぶとい (元↑速↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":-0.2}'>わんぱく (元↑食↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.00}'>のうてんき (元↑ス↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.00}'>のんき (元↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj":0.2}' >ひかえめ (食↑速↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.2}' >おっとり (食↑元↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.2}' >うっかりや (食↑ス↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.2}' >れいせい (食↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj":0.0}' >おだやか (ス↑速↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >おとなしい (ス↑元↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":-0.2}'>しんちょう (ス↑食↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >なまいき (ス↑E↓)</option>
                    <option value = '{"speedAdj":-0.09, "foodAdj":0.0}' >おくびょう (E↑速↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >せっかち (E↑元↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":-0.2}'>ようき (E↑食↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >むじゃき (E↑ス↓)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >がんばりや (無補正)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >すなお (無補正)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >てれや (無補正)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >きまぐれ (無補正)</option>
                    <option value = '{"speedAdj":0.00,  "foodAdj":0.0}' >まじめ (無補正)</option>
                </select>

                <div class="example2">
                    <input type="checkbox" id="input_mypoke_speeddS"><label for="input_mypoke_speeddS">おてスピS</label>
                    <input type="checkbox" id="input_mypoke_spdM"><label for="input_mypoke_spdM">おてスピM</label>
                    <input type="checkbox" id="input_mypoke_foodS"><label for="input_mypoke_foodS">食材S</label>
                    <input type="checkbox" id="input_mypoke_foodM"><label for="input_mypoke_foodM">食材M</label>
                </div>
                
                <br>
                <select id="input_mypoke_registered" style="width:15em; font-size:1em">
                    <option>Temp</option>
                </select>
                <button id="input_mypoke_delete" onclick="deleteRegisteredMypoke()">削除</button>




            </div>

            <div>

            </div>

            <div id="result">
                <table id="result_table">

                </table>
            </div>
        </p>




        <!--以下、スクリプト-->
        <script>

            function deleteRegisteredMypoke(){
                let list = document.getElementById("input_mypoke_registered");
                list.removeChild(list.children[list.selectedIndex]);

            }

            
            function setFoodImages(el){
                el = document.getElementById("input_mypoke_name");
                let poke = pokedex.getPokemonByName(el.value);
                if (poke == null){

                }
                
                let img1 = document.getElementById('input_mypoke_food_1');
                let img2 = document.getElementById('input_mypoke_food_2');
                let img3 = document.getElementById('input_mypoke_food_3');
                this.setFoodImageOnImgEl(img1, poke, 1);
                this.setFoodImageOnImgEl(img2, poke, 2);
                this.setFoodImageOnImgEl(img3, poke, 3);
            }


            function setFoodImageOnImgEl(el, poke, max){
                let values = poke.getAllFoodNames();
                let value = values[0];
                el.setAttribute("values", values.slice(0, max).join(","));
                el.setAttribute("value", value);
                el.setAttribute("code", "A")
                this.toggleFood(el, 0);
            }


            function toggleFood(el, setIndex = -1){
                let values = el.getAttribute("values").split(",");
                let index = values.indexOf(el.getAttribute("value"));
                let next = (setIndex != -1) ? setIndex
                          : ((index + 1) >= values.length) ? 0 : index + 1;
                
                el.src = el.getAttribute("dir") + values[next] + ".png";
                el.setAttribute("value", values[next]);
                el.setAttribute("code", String.fromCharCode(65 + next));
               
            }



            function addReportOf(sender){
                let foodName = sender.name;
                let min = document.getElementById('food_min').value;
                let onlyFullyEvolved = document.getElementById('only_fully_evolved').checked;
                let el = document.getElementById('result_table');
                el.innerHTML = "";
                el.appendChild(this.pokeReport.createReport(foodName, min, onlyFullyEvolved));

                let json = this.createMyPokeJsonFromInputForm(foodName);
                if (json == null) return;
                this.insertMyPokemon(json);
                let list = document.getElementById("input_mypoke_registered");
                list.children[0].value = JSON.stringify(json);
            }


            function createMyPokeJsonFromInputForm(foodName){
                let name = this.document.getElementById('input_mypoke_name').value;
                if (name == "") return null;

                return this.createAdjustJson(name, foodName);
            }


            function insertMyPokemon(json){
                let poke = pokedex.getPokemonByName(json.name);
                let comb = new FoodCombination(poke, json.lv, poke.getOtetsudaiCountDay(json.lv, json.speedAdj, json.subSpeedAdj), json.code, json.foodAdj + json.subFoodAdj);
                if (!comb.contains(json.food))   return;

                let tr = document.createElement('tr');
                tr.style.backgroundColor = '#CCDDFF';
                comb.insertResultTo(tr, json.food, poke);

                let tb = document.getElementById('result_table').tBodies[0];
                let rows = tb.children;

                let target = comb.getExpectionOf(json.food);
                for (let i = 0; i < rows.length; i++){
                    let value = rows[i].children[1].getAttribute('value');
                    if (value <= target){
                    tb.insertBefore(tr, rows[i]);
                        break;
                    }
                }
            }


            function createAdjustJson(name, foodName){
                let charList = document.getElementById("input_mypoke_char");
                let json = JSON.parse(charList.children[charList.selectedIndex].value);
                json.subSpeedAdj = (document.getElementById("input_mypoke_speeddS").checked) ? 0.07 : 0;
                json.subSpeedAdj += (document.getElementById("input_mypoke_spdM").checked) ? 0.14 : 0;
                json.subFoodAdj = (document.getElementById("input_mypoke_foodS").checked) ? 0.18 : 0;
                json.subFoodAdj += (document.getElementById("input_mypoke_foodM").checked) ? 0.36 : 0; 
                json.subSpeedAdj = Math.round(json.subSpeedAdj * 100) / 100;
                json.subFoodAdj = Math.round(json.subFoodAdj * 100) / 100;

                json.name = name;
                json.food = foodName;
                json.lv = this.document.getElementById('input_mypoke_lv').value;
                json.code = this.getMyPokeFoodCode();
                return json;
            }



            function getMyPokeFoodCode(){
                return document.getElementById("input_mypoke_food_1").getAttribute("code")
                     + document.getElementById("input_mypoke_food_2").getAttribute("code")
                     + document.getElementById("input_mypoke_food_3").getAttribute("code");
            }


            function initializePokeList(){
                if (this.selectBoxInitialized) return;

                let list = document.getElementById('input_mypoke_name');
                let blankOp = document.createElement('option');
                blankOp.text = "";
                blankOp.value = "";
                list.appendChild(blankOp);

                let names = pokemons.map(p => p.name).sort();
                for (let i = 0; i < names.length; i++){
                    let op = document.createElement('option');                    
                    op.text = names[i];
                    op.value = names[i];   
                    list.appendChild(op);                 
                }

                list = document.getElementById('input_mypoke_lv');
                blankOp = document.createElement('option');


                for (let i = 1; i <= 60; i++){
                    let op = document.createElement('option');                    
                    op.text = i;
                    op.value = i;   
                    list.appendChild(op);                 
                }
                list.selectedIndex = 0;

                this.selectBoxInitialized = true;
            }


            window.onload = ()=>{
                this.pokedex = new Pokedex();
                this.pokemons = pokedex.pokemons;
                this.pokeReport = new PokeReport(this.pokedex);
                this.pokeReport.initialize();
                this.selectBoxInitialized = false;
            }
        </script>
    </body>

</html>
